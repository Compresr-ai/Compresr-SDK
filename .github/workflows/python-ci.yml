name: Python SDK

on:
  push:
  pull_request:

jobs:
  style:
    name: Code Style & Linting
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: python
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Check code formatting with black
        run: black . --check --diff
      
      - name: Check import sorting with isort
        run: isort . --check-only --diff
      
      - name: Run type checker (mypy)
        run: mypy compresr
      
      - name: Run linter (ruff)
        run: ruff check .

  test:
    name: Test Python SDK
    runs-on: ubuntu-latest
    needs: style
    defaults:
      run:
        working-directory: python
    env:
      HAS_API_KEY: ${{ secrets.COMPRESR_API_KEY != '' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install SDK locally
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run unit tests
        run: pytest tests/unit -v
      
      - name: Run integration tests (production)
        if: env.HAS_API_KEY == 'true'
        env:
          COMPRESR_API_KEY: ${{ secrets.COMPRESR_API_KEY }}
          COMPRESR_BASE_URL: https://api.compresr.ai
        run: pytest tests/integration -v --timeout=60
      
      - name: Integration tests status
        if: env.HAS_API_KEY != 'true'
        run: |
          echo "⚠️  Integration tests skipped - COMPRESR_API_KEY secret not configured"
          echo "To enable: Add COMPRESR_API_KEY secret in repository settings"
          echo "To run locally: Start backend at http://localhost:8000 and run 'pytest tests/integration -v'"
